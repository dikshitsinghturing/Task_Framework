<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <link
      href="https://unpkg.com/vis-network@9.1.2/styles/vis-network.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Gordita", Tahoma, Geneva, Verdana, sans-serif;
        background: white;
        min-height: 100vh;
      }

      .dashboard-header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding: 1rem 2rem;
        top: 0;
        z-index: 100;
      }

      .logo {
        font-size: 1.8rem;
        font-weight: bold;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .selector-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 3rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        width: 100%;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .selector-title {
        font-size: 2rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 2rem;
        text-align: center;
        background: linear-gradient(135deg, rgb(102, 232, 234), #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .form-group {
        margin-bottom: 2rem;
      }

      .form-label {
        display: block;
        margin-bottom: 0.8rem;
        color: #555;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .input-container {
        position: relative;
        display: flex;
        align-items: center;
      }

      .input-icon {
        position: absolute;
        left: 15px;
        z-index: 10;
        color: rgb(172, 102, 234);
        font-size: 1.2rem;
      }

      .form-input {
        width: 100%;
        padding: 1rem 1rem 1rem 50px;
        border: 2px solid #e1e5e9;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #fafbfc;
      }

      .form-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: white;
      }

      .form-input.required {
        border-color: #ff4757;
        border-width: 2px;
      }

      .form-input.required:focus {
        border-color: #ff4757;
        box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1);
      }

      .form-select {
        width: 100%;
        padding: 1rem 1rem 1rem 50px;
        border: 2px solid #e1e5e9;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #fafbfc;
        cursor: pointer;
        appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23667eea" d="M6 9L1 4h10z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 15px center;
      }

      .form-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background-color: white;
      }

      .go-button {
        width: 25%;
        padding: 1.2rem 2rem;
        margin-top: 2rem;
        background: linear-gradient(135deg, rgb(102, 232, 234), #764ba2);
        color: white;
        border: none;
        border-radius: 15px;
        font-size: 1.2rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(172, 102, 234, 0.3);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .go-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(201, 102, 234, 0.4);
      }

      .go-button:active {
        transform: translateY(-1px);
      }

      .go-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .savePageContainer {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
        padding: 20px;
      }

      .save-button {
        display: inline;
        visibility: visible;
        background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(238, 90, 82, 0.3);
        margin-bottom: 20px;
      }

      .save-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(238, 90, 82, 0.4);
      }

      .import-button {
        display: inline;
        visibility: visible;
        background: linear-gradient(45deg, #2ed573, #1e824c);
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(46, 213, 115, 0.3);
        margin: 0 10px;
      }

      .import-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(46, 213, 115, 0.4);
      }

      .export-button {
        display: inline;
        visibility: visible;
        background: linear-gradient(
          45deg,
          rgb(234, 122, 102),
          rgb(143, 75, 162)
        );
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        margin: 0 10px;
      }

      .export-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }

      #actions {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
      }

      .add-action-button {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 15px 20px;
        font-size: 16px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        margin-bottom: 10px;
      }

      .add-action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }

      .add-action-text {
        font-size: 1.2rem;
        color: rgb(34, 95, 186);
        font-weight: bold;
      }

      /* New styles for API actions */
      .api-action {
        width: 100%;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 2rem;
        margin: 2rem 0;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        position: relative;
      }

      .api-action-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .api-action-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      #api-actions-container {
        width: 100%;
      }

      .remove-action-button {
        background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        color: white;
        border: none;
        padding: 8px 12px;
        font-size: 14px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(238, 90, 82, 0.3);
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .remove-action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(238, 90, 82, 0.4);
      }

      .api-description {
        background: rgba(102, 126, 234, 0.1);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        color: #555;
        font-style: italic;
      }

      .parameters-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .parameter-group {
        display: flex;
        flex-direction: column;
      }

      .parameter-label {
        font-weight: 600;
        color: #555;
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }

      .parameter-label.required::after {
        content: " *";
        color: #ff4757;
      }

      .parameter-input {
        padding: 0.8rem 1rem;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #fafbfc;
      }

      .parameter-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: white;
      }

      .parameter-input.required {
        border-color: #ff4757;
      }

      .parameter-input.required:focus {
        border-color: #ff4757;
        box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1);
      }

      .execute-button {
        width: 100%;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #2ed573, #1e824c);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(46, 213, 115, 0.3);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .execute-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(46, 213, 115, 0.4);
      }

      .execute-button:active {
        transform: translateY(-1px);
      }

      .execute-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .api-response {
        margin-top: 1.5rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        display: none;
      }

      .api-response.show {
        display: block;
      }

      .api-response.success {
        border-left-color: #2ed573;
        background: #f0fff4;
      }

      .api-response.error {
        border-left-color: #ff4757;
        background: #fff5f5;
      }

      .response-header {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #333;
      }

      .response-content {
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
        white-space: pre-wrap;
        background: white;
        padding: 1rem;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
      }

      /* Graph Editor Styles */
      .graph-editor-container {
        width: 100%;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        margin: 2rem 0;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .graph-editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        background: linear-gradient(
          135deg,
          rgba(102, 232, 234, 0.1),
          rgba(118, 75, 162, 0.1)
        );
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .graph-editor-header:hover {
        background: linear-gradient(
          135deg,
          rgba(102, 232, 234, 0.15),
          rgba(118, 75, 162, 0.15)
        );
      }

      .graph-editor-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .graph-editor-toggle {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }

      .graph-editor-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .graph-editor-content {
        display: none;
        padding: 2rem;
      }

      .graph-editor-content.expanded {
        display: block;
      }

      .graph-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }

      .graph-import-button {
        background: linear-gradient(45deg, #2ed573, #1e824c);
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 14px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(46, 213, 115, 0.3);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .graph-import-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(46, 213, 115, 0.4);
      }

      .graph-export-button {
        background: linear-gradient(
          45deg,
          rgb(234, 122, 102),
          rgb(143, 75, 162)
        );
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 14px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .graph-export-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }

      #network {
        width: 100%;
        height: 500px;
        border: 2px solid #e1e5e9;
        border-radius: 12px;
        background: #fafbfc;
      }

      @media (max-width: 768px) {
        .parameters-container {
          grid-template-columns: 1fr;
        }

        .go-button {
          width: 100%;
        }

        .selector-container {
          padding: 2rem;
        }

        .graph-controls {
          flex-direction: column;
          align-items: center;
        }

        .graph-import-button,
        .graph-export-button {
          width: 200px;
        }
      }

      .comparison-result {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 8px;
        font-weight: bold;
        text-align: center;
      }

      .comparison-result.match {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .comparison-result.no-match {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .comparison-details {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        font-weight: normal;
        text-align: left;
      }
    </style>
  </head>

  <body>
    <header class="dashboard-header">
      <div class="logo">
        <img
          id="image-logo"
          src="{{ url_for('static', filename='images/turing-logo-new.jpg') }}"
          alt="turing image"
          style="width: 100px; scale: 2; display: block; margin: 0 auto"
        />
      </div>
    </header>

    <div class="main-container">
      <main class="content-area">
        <div class="selector-container">
          <h1 class="selector-title">Task Framework</h1>
          <div class="form-group">
            <label for="environment" class="form-label">Environment</label>
            <div class="input-container">
              <span class="input-icon">🌍</span>
              <input
                type="text"
                id="environment"
                class="form-input"
                placeholder="Enter environment name (e.g., banking_system)"
                value="banking_system"
              />
            </div>
          </div>

          <!-- <div class="form-group">
            <label for="interface" class="form-label">Interface</label>
            <div class="input-container">
              <span class="input-icon">🔧</span>
              <select id="interface" class="form-select">
                <option value="">Select an interface</option>
                <option value="1">Interface 1</option>
                <option value="2">Interface 2</option>
                <option value="3" selected>Interface 3</option>
                <option value="4">Interface 4</option>
                <option value="5">Interface 5</option>
              </select>
            </div>
          </div> -->

          <div
            style="
              display: flex;
              justify-content: center;
              align-items: center;
              margin-top: 20px;
            "
          >
            <button class="go-button" onclick="handleGo()">🚀 GO</button>
          </div>
        </div>

        <div id="actions">
          <div
            class="add-action-container"
            style="
              height: 100px;
              display: flex;
              justify-content: center;
              align-items: center;
              flex-direction: column;
            "
          >
            <button class="add-action-button" onclick="addAction()">+</button>
            <span class="add-action-text">Add Action</span>
          </div>

          <div id="api-actions-container">
            <!-- Dynamic API actions will be added here -->
          </div>

          <div
            class="import-export-container"
            style="
              display: flex;
              justify-content: center;
              align-items: center;
              width: 100%;
              margin: 20px 0px;
              flex: 1.1;
            "
          >
            <div>
              <input
                type="file"
                id="fileInput"
                accept=".json"
                style="display: none"
              />
              <button class="import-button" onclick="importActions()">
                Import Actions
              </button>
            </div>

            <!-- <div>
              <button class="export-button" onclick="exportActions()">
                Export Actions
              </button>
            </div> -->
          </div>
        </div>

        <!-- Graph Editor Section -->
        <div class="graph-editor-container">
          <div class="graph-editor-header" onclick="toggleGraphEditor()">
            <div class="graph-editor-title">
              <span>📊</span>
              Graph Editor Playground
            </div>
            <button class="graph-editor-toggle" id="graph-toggle">▼</button>
          </div>
          <div class="graph-editor-content" id="graph-editor-content">
            <div class="graph-controls">
              <button class="graph-import-button" onclick="importGraphJSON()">
                📥 Import Graph
              </button>
              <button class="graph-export-button" onclick="exportGraphJSON()">
                📤 Export Graph
              </button>
              <button
                class="graph-import-button"
                onclick="populateNodesFromActions()"
              >
                📝 Populate Nodes from Actions
              </button>
            </div>
            <div id="network"></div>
            <input
              type="file"
              id="graphFileInput"
              accept=".json"
              style="display: none"
            />
          </div>
        </div>

        <div
          style="
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
          "
        >
          <button class="save-button" onclick="saveFilteredHTML()">
            Save Page
          </button>
        </div>
      </main>
    </div>
    <script>
      /* function testClick() {
            alert("Test button clicked!");
            apis = document.querySelectorAll('.api-action')
            
            actions = [];
            for (const api of apis) {
                action = {};
                var api_name = api.getElementsByClassName("form-select")[0];
                var api_name = api_name.options[api_name.selectedIndex].text;
                action["name"] = api_name;

                
                const argumentsKeyValue = {};
                const arguments = api.querySelectorAll('input');
                arguments.forEach(argument => {
                    const paramName = argument.dataset.param;
                    argumentsKeyValue[paramName] = argument.value.trim();
                });
                action["arguments"] =argumentsKeyValue;

                actions.push(action);
            }
            console.log("API actions:", actions);
        } */

      const APIs = new Map();
      let actionCounter = 0;

      async function handleGo() {
        const environment = document.getElementById("environment").value.trim();
        // const interface = document.getElementById("interface").value;

        if (!environment) {
          showWrongMessage("Please enter an environment name");
          return;
        }

        // if (!interface) {
        //   showWrongMessage("Please select an interface");
        //   return;
        // }

        console.log("Environment:", environment);
        // console.log("Interface:", interface);

        try {
          const response = await fetch(
            "http://127.0.0.1:5000/choose_env_interface",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                environment: environment,
                // interface: interface,
              }),
            }
          );

          if (!response.ok) {
            showWrongMessage("Failed to select Environment and Interface.");
            return;
          }

          const data = await response.json();
          if (data.status === "success") {
            showCorrectMessage(
              "Environment selected successfully!"
            );
            console.log("Response:", data);

            // Clear existing APIs
            APIs.clear();

            // Populate APIs from response
            console.log("Functions info:", data);
            for (const func of data.functions_info) {
              APIs.set(func.name, {
                description: func.description,
                parameters: func.parameters,
                required: func.required,
              });
            }
            console.log("APIs:", APIs);
          } else {
            showWrongMessage("Failed to select Environment and Interface.");
          }
        } catch (error) {
          console.error("Error:", error);
          showWrongMessage("An error occurred while connecting to the server.");
        }
      }

      function addAction() {
        if (APIs.size === 0) {
          showWrongMessage(
            "Please select an environment and interface first by clicking GO."
          );
          return [null, null];
        }

        actionCounter++;
        const actionId = `action_${actionCounter}`;

        const actionContainer = document.getElementById(
          "api-actions-container"
        );

        const actionDiv = document.createElement("div");
        actionDiv.className = "api-action";
        actionDiv.id = actionId;

        actionDiv.innerHTML = `
                <div class="api-action-header">
                    <div class="api-action-title">Action</div>
                    <button class="remove-action-button" onclick="removeAction('${actionId}')">×</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select API</label>
                    <div class="input-container">
                        <span class="input-icon">🔌</span>
                        <select class="form-select" onchange="selectAPI('${actionId}', this.value)">
                            <option value="">Choose an API...</option>
                            ${Array.from(APIs.keys())
                              .map(
                                (apiKey) =>
                                  `<option value="${apiKey}">${apiKey}</option>`
                              )
                              .join("")}
                        </select>
                    </div>
                </div>
                
                <div id="${actionId}_description" class="api-description" style="display: none;"></div>
                <div id="${actionId}_parameters" class="parameters-container"></div>
                <div id="${actionId}_execute" style="display: none;">
                    <button class="execute-button" onclick="executeAPI('${actionId}')">
                        🚀 Execute API
                    </button>
                </div>
                <div style="display: flex; gap: 16px; width: 100%;">
                <div style="width: 50%;">
                    <div id="${actionId}_expected" class="api-response show" style="border-left-color: #aaa;">
                    <div class="response-header">📦 Expected Output</div>
                    <div class="response-content" style="background: #f5f5f5; height: 300px; overflow: auto;">
                        <pre style="white-space: pre-wrap; word-break: break-word;"></pre>
                    </div>
                    </div>
                </div>
                <div style="width: 50%;">
                    <div id="${actionId}_response" class="api-response">
                    <div class="response-header">🚀 Live Output</div>
                    <div class="response-content" style="background: #ffffff; height: 300px; overflow: auto;">
                        <pre style="white-space: pre-wrap; word-break: break-word;"></pre>
                    </div>
                    </div>
                </div>
                </div>


            `;
        document.getElementsByClassName("add-action-container")[0].remove();
        const addAction = document.createElement("div");
        addAction.className = "add-action-container";
        addAction.style =
          "height: 100px; display: flex; justify-content: center; align-items: center; flex-direction: column;";
        addAction.innerHTML = `
                <button class="add-action-button" onclick="addAction()">
                    +
                </button>
                <span class="add-action-text">Add Action</span>
            `;

        actionContainer.appendChild(actionDiv);
        actionContainer.appendChild(addAction);

        // Scroll to the new action
        // actionDiv.scrollIntoView({ behavior: "smooth", block: "center" });
        return [actionId, actionDiv];
      }

      function removeAction(actionId) {
        const actionDiv = document.getElementById(actionId);
        actionCounter--;
        if (actionDiv) {
          actionDiv.remove();
        }
      }

      function selectAPI(actionId, apiKey) {
        const descriptionDiv = document.getElementById(
          `${actionId}_description`
        );
        const parametersDiv = document.getElementById(`${actionId}_parameters`);
        const executeDiv = document.getElementById(`${actionId}_execute`);
        const responseDiv = document.getElementById(`${actionId}_response`);

        // Clear previous content
        parametersDiv.innerHTML = "";
        responseDiv.innerHTML = "";
        responseDiv.className = "api-response";

        if (!apiKey) {
          descriptionDiv.style.display = "none";
          executeDiv.style.display = "none";
          return;
        }

        const apiInfo = APIs.get(apiKey);
        if (!apiInfo) return;

        // Show description
        descriptionDiv.innerHTML = apiInfo.description;
        descriptionDiv.style.display = "block";

        // Create parameter inputs
        if (apiInfo.parameters) {
          Object.entries(apiInfo.parameters).forEach(
            ([paramName, paramInfo]) => {
              const isRequired =
                apiInfo.required && apiInfo.required.includes(paramName);

              const paramDiv = document.createElement("div");
              paramDiv.className = "parameter-group";

              paramDiv.innerHTML = `
                        <label class="parameter-label ${
                          isRequired ? "required" : ""
                        }">${paramName}</label>
                        <input 
                            type="text" 
                            class="parameter-input ${
                              isRequired ? "required" : ""
                            }"
                            placeholder="${
                              paramInfo.description || `Enter ${paramName}`
                            }"
                            data-param="${paramName}"
                            ${isRequired ? "required" : ""}
                        >
                    `;

              parametersDiv.appendChild(paramDiv);
            }
          );
        }

        // Show execute button
        executeDiv.style.display = "block";
      }

      async function executeAPI(actionId) {
        const actionDiv = document.getElementById(actionId);
        const apiSelect = actionDiv.querySelector("select");
        const selectedAPI = apiSelect.value;

        if (!selectedAPI) {
          showWrongMessage("Please select an API first.");
          return;
        }

        // Collect parameters
        const parameters = {};
        const paramInputs = actionDiv.querySelectorAll(".parameter-input");
        let hasError = false;

        paramInputs.forEach((input) => {
          const paramName = input.dataset.param;
          const value = input.value.trim();

          if (input.classList.contains("required") && !value) {
            input.style.borderColor = "#ff4757";
            hasError = true;
          } else {
            input.style.borderColor = "#e1e5e9";
            parameters[paramName] = value;
          }
        });

        if (hasError) {
          showWrongMessage("Please fill in all required fields.");
          return;
        }

        // Show loading state
        const executeButton = actionDiv.querySelector(".execute-button");
        const originalText = executeButton.textContent;
        executeButton.textContent = "⏳ Executing...";
        executeButton.disabled = true;

        const responseDiv = document.getElementById(`${actionId}_response`);
        responseDiv.innerHTML =
          '<div class="response-header">Executing API...</div>';
        responseDiv.className = "api-response show";

        try {
          const response = await fetch("http://127.0.0.1:5000/execute_api", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              api_name: selectedAPI,
              parameters: parameters,
            }),
          });

          const result = await response.json();

          function fixNewlines(obj) {
            if (typeof obj === "string") {
              return obj.replace(/\\n/g, "\n");
            }
            if (Array.isArray(obj)) {
              return obj.map(fixNewlines);
            }
            if (obj && typeof obj === "object") {
              const fixed = {};
              for (let key in obj) {
                fixed[key] = fixNewlines(obj[key]);
              }
              return fixed;
            }
            return obj;
          }
          if (response.ok) {
            responseDiv.className = "api-response show success";
            responseDiv.innerHTML = `
                        <div class="response-header">✅ Success</div>
                        <div class="response-content"><pre></pre></div>
                        <div id="${actionId}_comparison"></div>
                    `;
            // Set the JSON content as text to preserve literals

            // Process the data to convert literal \n to actual newlines

            const fixedResult = fixNewlines(result);
            responseDiv.querySelector("pre").textContent = JSON.stringify(
              fixedResult,
              null,
              2
            );
            // Compare with expected output
            const expectedDiv = document.getElementById(`${actionId}_expected`);
            const expectedContent = expectedDiv
              .querySelector("pre")
              .textContent.trim();

            if (expectedContent) {
              const comparison = compareOutputs(
                expectedContent,
                JSON.stringify(result, null, 2)
              );
              const comparisonDiv = document.getElementById(
                `${actionId}_comparison`
              );

              comparisonDiv.innerHTML = `
            <div class="comparison-result ${
              comparison.match ? "match" : "no-match"
            }">
                ${
                  comparison.match
                    ? "✅ OUTPUTS MATCH!"
                    : "❌ OUTPUTS DO NOT MATCH"
                }
                <div class="comparison-details">
                    ${comparison.details
                      .map((detail) => `<div>• ${detail}</div>`)
                      .join("")}
                </div>
            </div>
        `;
            }
            showCorrectMessage("API executed successfully!");
          } else {
            responseDiv.className = "api-response show error";
            responseDiv.innerHTML = `
                        <div class="response-header">❌ Error</div>
                        <div class="response-content">${JSON.stringify(
                          result,
                          null,
                          2
                        )}</div>
                    `;
            showWrongMessage(
              "API execution failed. Check the response for details."
            );
          }
        } catch (error) {
          responseDiv.className = "api-response show error";
          responseDiv.innerHTML = `
                    <div class="response-header">❌ Network Error</div>
                    <div class="response-content">Failed to connect to the server: ${error.message}</div>
                `;
          showWrongMessage("Network error occurred while executing the API.");
        } finally {
          executeButton.textContent = originalText;
          executeButton.disabled = false;
        }
      }

      function showCorrectMessage(text) {
        const message = document.createElement("div");
        message.textContent = text;
        message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4caf50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                font-family: Arial, sans-serif;
                transition: all 0.3s ease;
            `;
        document.body.appendChild(message);

        setTimeout(() => {
          message.style.opacity = "0";
          message.style.transform = "translateY(-20px)";
          setTimeout(() => {
            document.body.removeChild(message);
          }, 300);
        }, 3000);
      }

      function showWrongMessage(text) {
        const message = document.createElement("div");
        message.textContent = text;
        message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f44336;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                font-family: Arial, sans-serif;
                transition: all 0.3s ease;
            `;
        document.body.appendChild(message);

        setTimeout(() => {
          message.style.opacity = "0";
          message.style.transform = "translateY(-20px)";
          setTimeout(() => {
            document.body.removeChild(message);
          }, 300);
        }, 3000);
      }

      function saveFilteredHTML() {
        // Clone the entire document
        const clonedDoc = document.cloneNode(true);

        // Sync input, textarea, and select values manually to clonedDoc
        const originalElements = document.querySelectorAll(
          "input, textarea, select"
        );
        const clonedElements = clonedDoc.querySelectorAll(
          "input, textarea, select"
        );

        originalElements.forEach((originalEl, index) => {
          const clonedEl = clonedElements[index];
          if (!clonedEl) return;

          switch (originalEl.tagName) {
            case "TEXTAREA":
              clonedEl.innerHTML = originalEl.value;
              break;
            case "SELECT":
              Array.from(clonedEl.options).forEach((option) => {
                option.removeAttribute("selected");
                if (option.value === originalEl.value) {
                  option.setAttribute("selected", "selected");
                }
              });
              break;
            case "INPUT":
              if (
                originalEl.type === "checkbox" ||
                originalEl.type === "radio"
              ) {
                if (originalEl.checked) {
                  clonedEl.setAttribute("checked", "");
                } else {
                  clonedEl.removeAttribute("checked");
                }
              } else {
                clonedEl.setAttribute("value", originalEl.value);
              }
              break;
          }
        });

        // Remove unwanted elements
        const logo = clonedDoc.getElementById("image-logo");
        if (logo) logo.remove();

        // const elementsToExclude = clonedDoc.querySelectorAll('.save-button');
        // elementsToExclude.forEach(el => el.remove());

        const formTitle = clonedDoc.querySelector(
          "main.content-area .form-title"
        );
        if (formTitle) formTitle.remove();

        const formTextarea = clonedDoc.querySelector(
          "main.content-area .form-textarea"
        );
        if (formTextarea) formTextarea.remove();

        const queryBtn = clonedDoc.querySelector(
          "main.content-area .query-btn"
        );
        if (queryBtn) queryBtn.remove();

        // Save as an HTML file
        const htmlContent =
          "<!DOCTYPE html>\n" + clonedDoc.documentElement.outerHTML;
        const blob = new Blob([htmlContent], { type: "text/html" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "filtered_page.html";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(url);
        showCorrectMessage("Page saved successfully!");
      }

      function importActions() {
        const input = document.getElementById("fileInput");
        input.value = "";
        input.click();
        input.onchange = () => {
          const file = input.files[0];
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const obj = JSON.parse(e.target.result);
              console.log("Imported actions:", obj);
              // const added = new Set();
              let imported_actions = obj.actions;
              // let actions_interface = obj.interface_num;
              if (!obj.actions || !Array.isArray(obj.actions)) {
                imported_actions = obj.task.actions;
                // actions_interface = obj.task.interface_num;
              }

              // var interface_selected =
              //   document.getElementsByClassName("form-select")[0];
              // var interface_selected_text =
              //   interface_selected.options[interface_selected.selectedIndex]
              //     .text;
              // interface_selected_text = interface_selected_text.split(" ")[1];
              // console.log(interface_selected_text, actions_interface);
              // if (
              //   actions_interface &&
              //   parseInt(actions_interface) !==
              //     parseInt(interface_selected_text)
              // ) {
              //   showWrongMessage(
              //     `The imported actions are for the interface: ${actions_interface} whereas the environment is using interface: ${interface_selected_text}. Please select the correct interface first.`
              //   );
              //   return;
              // }

              imported_actions.forEach((action) => {
                // if (added.has(action.name)) return;
                // added.add(action.name);
                [actionID, actionDiv] = addAction();
                if (actionID === null || actionDiv === null) return;
                actionDiv.querySelector("select").value = action.name;
                selectAPI(actionID, action.name);
                actionDiv
                  .querySelectorAll(".parameter-input")
                  .forEach((input) => {
                    const paramName = input.dataset.param;
                    let value = action.arguments[paramName];
                    if (value !== undefined) {
                      // Check if value is a non-null object (but not an array or Date)
                      if (
                        typeof value === "object" &&
                        value !== null &&
                        !Array.isArray(value)
                      ) {
                        try {
                          value = JSON.stringify(value);
                        } catch (e) {
                          console.warn(
                            `Failed to stringify value for ${paramName}`,
                            e
                          );
                        }
                      }
                      input.value = value;
                    }
                  });
                // console.log('Action ID:', actionID);
                const expectedDiv = actionDiv.querySelector(
                  `#${actionID}_expected pre`
                );
                if (expectedDiv && action.output !== undefined) {
                  expectedDiv.textContent = JSON.stringify(
                    { output: action.output },
                    null,
                    2
                  );
                }
              });
            } catch (error) {
              console.error("Error importing actions:", error);
              showWrongMessage(
                "Failed to import actions. Please check the file format."
              );
            }
          };
          reader.readAsText(file);
        };
      }

      function exportActions() {
        const actions = [];
        const actionElements = document.querySelectorAll(".api-action");

        actionElements.forEach((actionEl) => {
          const apiSelect = actionEl.querySelector("select");
          const selectedAPI = apiSelect.value;

          if (!selectedAPI) return;

          const parameters = {};
          const paramInputs = actionEl.querySelectorAll(".parameter-input");

          paramInputs.forEach((input) => {
            const paramName = input.dataset.param;
            const value = input.value.trim();
            if (value !== "") {
              parameters[paramName] = value;
            }
          });
          // console.log(actionEl.querySelector('.response-content'))
          output = actionEl.querySelector(".response-content");
          if (output) {
            output = JSON.parse(output.textContent.trim());
            if (output.hasOwnProperty("output")) {
              output = output.output;
            } else {
              output = "";
            }
          } else {
            output = "";
          }

          actions.push({
            name: selectedAPI,
            arguments: parameters,
            output: output,
          });
        });

        const exportData = { actions: actions };
        const blob = new Blob([JSON.stringify(exportData, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "actions.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Graph Editor Variables
      // Graph Editor Variables
      const nodes = new vis.DataSet([]);
      const edges = new vis.DataSet([]);
      let network = null;
      let graphExpanded = false;

      const defaultOptions = {
        manipulation: {
          enabled: true,
          initiallyActive: true,
          addNode: function (data, callback) {
            const label = prompt("Enter node label:", data.id);
            if (label !== null) {
              data.label = label;
              data.id = label;
              callback(data);
            }
          },
          addEdge: function (data, callback) {
            if (data.from === data.to) {
              alert("Self-loops not allowed.");
              return;
            }
            const label = prompt("Enter edge connection (input->output):", "");
            if (label !== null && label !== "") {
              data.label = label;
            }
            callback(data);
          },
          editNode: function (data, callback) {
            const label = prompt("Edit node label:", data.label);
            if (label !== null) {
              data.label = label;
              nodes.update({ id: data.id, label: label });
              callback(data);
            }
          },
          editEdge: function (data, callback) {
            const label = prompt(
              "Edit edge connection (input->output):",
              data.label
            );
            if (label !== null) {
              data.label = label;
              callback(data);
            }
          },
          deleteNode: true,
          deleteEdge: true,
        },
        nodes: {
          shape: "circle",
        },
        edges: { arrows: "to" },
        physics: false,
        layout: { improvedLayout: false },
      };

      function createNetwork(options = defaultOptions) {
        if (network) network.destroy();
        const container = document.getElementById("network");
        network = new vis.Network(container, { nodes, edges }, options);
      }

      function toggleGraphEditor() {
        const content = document.getElementById("graph-editor-content");
        const toggle = document.getElementById("graph-toggle");

        graphExpanded = !graphExpanded;

        if (graphExpanded) {
          content.classList.add("expanded");
          toggle.textContent = "▲";
          // Initialize network when expanded for the first time
          if (!network) {
            createNetwork();
          }
        } else {
          content.classList.remove("expanded");
          toggle.textContent = "▼";
        }
      }

      function exportGraphJSON() {
        const edgeList = [];
        const edgeMap = new Map();

        edges.get().forEach((edge) => {
          const fromLabel = nodes.get(edge.from)?.label || edge.from;
          const toLabel = nodes.get(edge.to)?.label || edge.to;
          const key = `${fromLabel}->${toLabel}`;
          const conn =
            edge.label?.split(",").map((pair) => pair.trim().split("->")) || [];
          if (!edgeMap.has(key)) {
            edgeMap.set(key, []);
          }
          edgeMap.get(key).push(...conn);
        });

        for (let [key, connections] of edgeMap.entries()) {
          const [from, to] = key.split("->");
          const inputs = connections.map((c) => c[0]).join(", ");
          const outputs = connections.map((c) => c[1]).join(", ");
          edgeList.push({
            from,
            to,
            connection: { input: inputs, output: outputs },
          });
        }

        const exportData = { edges: edgeList };
        const blob = new Blob([JSON.stringify(exportData, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "graph.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showCorrectMessage("Graph exported successfully!");
      }

      function importGraphJSON() {
        const input = document.getElementById("graphFileInput");
        input.value = "";
        input.click();
        input.onchange = () => {
          const file = input.files[0];
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const obj = JSON.parse(e.target.result);
              nodes.clear();
              edges.clear();
              const added = new Set();
              const uniqueNodes = new Set();
              let imported_edges = obj.edges;
              if (!obj.edges || !Array.isArray(obj.edges)) {
                imported_edges = obj.task.edges;
              }

              imported_edges.forEach((e) => {
                uniqueNodes.add(e.from);
                uniqueNodes.add(e.to);
              });

              let angle = 0;
              const radius = 200;
              const step = (2 * Math.PI) / uniqueNodes.size;

              [...uniqueNodes].forEach((node) => {
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);
                angle += step;
                nodes.add({ id: node, label: node, x, y, fixed: false });
              });

              imported_edges.forEach((e) => {
                const inputFields = e.connection.input
                  .split(",")
                  .map((s) => s.trim());
                const outputFields = e.connection.output
                  .split(",")
                  .map((s) => s.trim());
                const pairs = inputFields.map(
                  (input, i) => `${input}->${outputFields[i]}`
                );
                const edgeId = `${e.from}-${e.to}`;

                if (!added.has(edgeId)) {
                  edges.add({
                    from: e.from,
                    to: e.to,
                    label: pairs.join(", "),
                    arrows: "to",
                  });
                  added.add(edgeId);
                }
              });

              if (network) {
                network.setData({ nodes, edges });
              }
              showCorrectMessage("Graph imported successfully!");
            } catch (error) {
              console.error("Error importing graph:", error);
              showWrongMessage("Error importing graph: " + error.message);
            }
          };
          reader.readAsText(file);
        };
      }

      function populateNodesFromActions() {
        // Initialize nodeList as an empty array
        let nodeList = [];

        // Get the actions container
        const actions = document.querySelector("#actions");

        // Extract values from all select elements
        actions.querySelectorAll("select").forEach((select) => {
          if (select.value && select.value.trim() !== "") {
            nodeList.push(select.value);
          }
        });

        // Check if we have any nodes to work with
        if (nodeList.length === 0) {
          showWrongMessage("There are no actions to populate nodes from.");
          return;
        }

        try {
          // Remove duplicates (optional - in case same node appears multiple times)
          const uniqueNodeNames = [...new Set(nodeList)];

          // Clear existing nodes and edges
          nodes.clear();
          edges.clear();

          // Calculate positions for nodes in a circle
          const radius = 200;
          const angleStep = (2 * Math.PI) / uniqueNodeNames.length;

          uniqueNodeNames.forEach((nodeName, index) => {
            const angle = index * angleStep;
            const x = radius * Math.cos(angle);
            const y = radius * Math.sin(angle);

            nodes.add({
              id: nodeName,
              label: nodeName,
              x: x,
              y: y,
              fixed: false,
            });
          });

          // Update the network if it exists
          if (network) {
            network.setData({ nodes, edges });
          }

          showCorrectMessage(
            `Successfully populated ${uniqueNodeNames.length} nodes!`
          );
        } catch (error) {
          showWrongMessage("Error creating nodes: " + error.message);
        }
      }

      function compareOutputs(expected, actual) {
        try {
          const expectedObj =
            typeof expected === "string" ? JSON.parse(expected) : expected;
          const actualObj =
            typeof actual === "string" ? JSON.parse(actual) : actual;

          const expectedOutput = expectedObj.output || expectedObj;
          const actualOutput = actualObj.output || actualObj;

          // For arrays, sort them before comparison to ignore ordering
          if (Array.isArray(expectedOutput) && Array.isArray(actualOutput)) {
            const sortedExpected = JSON.stringify(
              expectedOutput
                .map((item) =>
                  typeof item === "object" ? sortObjectKeys(item) : item
                )
                .sort((a, b) =>
                  JSON.stringify(a).localeCompare(JSON.stringify(b))
                )
            );

            const sortedActual = JSON.stringify(
              actualOutput
                .map((item) =>
                  typeof item === "object" ? sortObjectKeys(item) : item
                )
                .sort((a, b) =>
                  JSON.stringify(a).localeCompare(JSON.stringify(b))
                )
            );

            const isEqual = sortedExpected === sortedActual;
            return {
              match: isEqual,
              details: [
                isEqual
                  ? "✅ Outputs match exactly"
                  : "❌ Array contents are different",
              ],
            };
          }

          // For objects, sort keys before comparison
          if (
            typeof expectedOutput === "object" &&
            typeof actualOutput === "object"
          ) {
            const sortedExpected = JSON.stringify(
              sortObjectKeys(expectedOutput)
            );
            const sortedActual = JSON.stringify(sortObjectKeys(actualOutput));

            const isEqual = sortedExpected === sortedActual;

            if (isEqual) {
              return {
                match: true,
                details: ["✅ Outputs match exactly"],
              };
            }

            // Show what's different
            const expectedKeys = Object.keys(expectedOutput);
            const actualKeys = Object.keys(actualOutput);

            const missingKeys = expectedKeys.filter(
              (key) => !actualKeys.includes(key)
            );
            const extraKeys = actualKeys.filter(
              (key) => !expectedKeys.includes(key)
            );
            const mismatchedKeys = [];

            // Check values for common keys
            expectedKeys
              .filter((key) => actualKeys.includes(key))
              .forEach((key) => {
                if (
                  JSON.stringify(sortObjectKeys(expectedOutput[key])) !==
                  JSON.stringify(sortObjectKeys(actualOutput[key]))
                ) {
                  mismatchedKeys.push(key);
                }
              });

            const details = [];
            if (missingKeys.length > 0) {
              details.push(`❌ Missing keys: ${missingKeys.join(", ")}`);
            }
            if (extraKeys.length > 0) {
              details.push(`❌ Extra keys: ${extraKeys.join(", ")}`);
            }
            if (mismatchedKeys.length > 0) {
              details.push(`❌ Value mismatches: ${mismatchedKeys.join(", ")}`);
            }

            return {
              match: false,
              details: details,
            };
          }

          // For primitives
          const isEqual = expectedOutput === actualOutput;
          return {
            match: isEqual,
            details: [
              isEqual ? "✅ Outputs match exactly" : "❌ Values are different",
            ],
          };
        } catch (error) {
          return {
            match: false,
            details: [`❌ Error: ${error.message}`],
          };
        }
      }

      // Helper function to sort object keys recursively
      function sortObjectKeys(obj) {
        if (Array.isArray(obj)) {
          return obj.map(sortObjectKeys);
        } else if (obj !== null && typeof obj === "object") {
          const sorted = {};
          Object.keys(obj)
            .sort()
            .forEach((key) => {
              sorted[key] = sortObjectKeys(obj[key]);
            });
          return sorted;
        }
        return obj;
      }
    </script>
  </body>
</html>
